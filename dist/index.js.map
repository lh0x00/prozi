{"version":3,"file":"index.js","sources":["../src/utilities/fastObjectProperties.ts","../src/Quiz.ts"],"sourcesContent":["import create from 'to-fast-properties'\n\nfunction fastObjectProperties<T extends object>(data?: T): T {\n  return create<T>(data)\n}\n\nexport default fastObjectProperties\n","/* eslint-disable @typescript-eslint/return-await */\n/* eslint-disable @typescript-eslint/no-floating-promises */\n\nimport fastObjectProperties from './utilities/fastObjectProperties'\nimport throat from './utilities/throat'\nimport {\n  type PromiseType, \n} from './types'\n\ninterface QuizThroatOptions {\n  concurrency: number\n  schedule: boolean\n}\n\ninterface QuizDeferPromise<T extends any> {\n  cancel: EnhancedPromise<T>['cancel']\n  flush: () => any\n  is: {\n    finalled: () => boolean\n    rejected: () => boolean\n    resolved: () => boolean\n  }\n  promise: EnhancedPromise<T>\n  reject: (reason?: any) => any\n  resolve: (value: T | PromiseLike<T>) => any\n  state: 'pending' | 'rejected' | 'resolved'\n}\n\ninterface QuizDeferifyPromise<T extends any, F = any>\n  extends QuizDeferPromise<T> {\n  forward: F\n}\n\ntype QuizPromiseExecuter<T extends any> = (\n  resolve: (value: T | PromiseLike<T>) => any,\n  reject: (reason?: any) => any,\n) => any\n\ntype QuizQueueItem = () => Promise<any>\n\ninterface QuizPromiseOptions {\n  cancelable?: boolean\n  timeout?: number\n}\n\ninterface EnhancedPromise<T extends any> extends Promise<T> {\n  cancel: () => any\n}\n\n//\ntype QuizCallbackError = Error | string | null | any | undefined\ntype QuizFunctionCallback<R> = (error: QuizCallbackError, results: R) => any\ntype QuizFunctionWithCallback<T extends any[], R> = (\n  ...args: [...T, QuizFunctionCallback<R>]\n) => any\n\nclass Quiz {\n  static readonly defaults = fastObjectProperties({\n    concurrency: 4,\n  })\n\n  static wrap<T extends any[], U>(\n    run: (...args: T) => U | PromiseLike<U>,\n  ): (...args: T) => Promise<U> {\n    return async function (this: any, ...rest: T) {\n      // eslint-disable-next-line @typescript-eslint/no-this-alias\n      const context = this\n\n      return Quiz.create(async (resolve, reject) => {\n        try {\n          resolve(Promise.resolve(run.apply(context, rest)))\n        } catch (error) {\n          reject(error)\n        }\n      })\n    }\n  }\n\n  static async immediate<T extends any>(\n    task?: () => T | PromiseLike<T>,\n  ): Promise<T> {\n    return Quiz.create((resolve, reject) => {\n      Promise.resolve().then(() => {\n        Promise.resolve((typeof task === 'function' ? task() : null) as any)\n          .then(resolve)\n          .catch(reject)\n      })\n    })\n  }\n\n  static async timeout<T extends any>(\n    task?: () => T | PromiseLike<T>,\n    delay = 0,\n  ): Promise<T> {\n    return Quiz.create((resolve, reject) => {\n      setTimeout(() => {\n        Promise.resolve((typeof task === 'function' ? task() : null) as any)\n          .then(resolve)\n          .catch(reject)\n      }, delay)\n    })\n  }\n\n  static async throat<I extends any, R extends any>(\n    list: I[],\n    task: (item: I, idx?: number) => Promise<R>,\n    options?: Partial<QuizThroatOptions>,\n  ): Promise<R[]> {\n    if (!list || !Array.isArray(list) || !('map' in list)) {\n      throw new Error(\n        'The parameter list received is invalid,' +\n          \"it's must be a list or support `map` prototype.\",\n      )\n    }\n\n    const opts = Object.assign(\n      {\n        concurrency: this.defaults.concurrency,\n        schedule: false,\n      },\n      options,\n    )\n\n    if (opts.concurrency <= 0) {\n      throw new Error('Quiz throat required concurrency value is greater 0.')\n    }\n\n    return Quiz.map(list, task, opts)\n  }\n\n  static async map<I extends any, R extends any>(\n    list: I[],\n    task: (item: I, idx?: number) => Promise<R>,\n    options?: Partial<QuizThroatOptions>,\n  ): Promise<R[]> {\n    if (!list || !Array.isArray(list) || !('map' in list)) {\n      throw new Error(\n        'The parameter list received is invalid,' +\n          \"it's must be a list or support `map` prototype.\",\n      )\n    }\n\n    const opts = Object.assign(\n      {\n        concurrency: -1,\n        schedule: false,\n      },\n      options,\n    )\n\n    return Quiz.all(\n      list.map(opts.concurrency > 0 ? throat(opts.concurrency, task) : task),\n    )\n  }\n\n  static async from<T extends Record<string, Promise<any>>>(\n    promises: T,\n  ): Promise<{\n    [K in keyof T]: PromiseType<T[K]>\n  }> {\n    const keys = Object.keys(promises)\n    const values = Object.values(promises)\n    const recevied: any[] = await this.all(values)\n\n    const results = recevied.reduce(\n      (acc, item, idx) =>\n        Object.assign(acc, {\n          [keys[idx]]: item,\n        }),\n      fastObjectProperties(),\n    )\n\n    return results\n  }\n\n  static async all<I extends any>(\n    ...rest: Array<Promise<I> | Array<Promise<I>>>\n  ): Promise<I[]> {\n    const promises: Array<Promise<any>> = rest.reduce<any>(\n      (acc, item) => acc.concat(item),\n      [],\n    )\n\n    return Promise.all(promises)\n  }\n\n  static readonly race = async <I extends any>(\n    ...rest: Array<Promise<I> | Array<Promise<I>>>\n  ): Promise<I> => {\n    const promises: Array<Promise<any>> = rest.reduce<any>(\n      (acc, item) => acc.concat(item),\n      [],\n    )\n\n    return Promise.race(promises)\n  }\n\n  static defer<T extends any>(\n    options?: QuizPromiseOptions,\n  ): QuizDeferPromise<T> {\n    const opts = Object.assign(\n      {\n        timeout: -1,\n        cancelable: true,\n      },\n      options,\n    )\n\n    const defered = fastObjectProperties({}) as QuizDeferPromise<T>\n\n    defered.state = 'pending'\n    defered.is = fastObjectProperties({\n      finalled: () =>\n        defered.state === 'resolved' || defered.state === 'rejected',\n      resolved: () => defered.state === 'resolved',\n      rejected: () => defered.state === 'rejected',\n    })\n\n    // @ts-expect-error\n    defered.promise = new Promise((resolve, reject) => {\n      defered.resolve = resolve\n      defered.reject = reject\n\n      if (opts.cancelable) {\n        Promise.resolve().then(() => {\n          defered.cancel = defered.promise.cancel = function () {\n            const error = new Error('The promise have been canceled.')\n            error.name = 'PromiseCanceled'\n\n            defered.reject(error)\n          }\n        })\n      }\n\n      if (opts.timeout > 0) {\n        let timer = setTimeout(() => {\n          timer = -1 as any\n\n          const error = new Error('The promise has been timedout.')\n          error.name = 'PromiseTimedout'\n\n          defered.reject(error)\n        }, opts.timeout)\n\n        defered.flush = function () {\n          clearTimeout(timer)\n\n          timer = -1 as any\n        }\n\n        defered.promise.finally(() => {\n          defered.flush()\n        })\n      }\n    })\n\n    //\n    defered.promise\n      .then(() => (defered.state = 'resolved'))\n      .catch(() => (defered.state = 'rejected'))\n\n    return defered\n  }\n\n  // eslint-disable-next-line @typescript-eslint/promise-function-async\n  static run<T extends any>(\n    task: () => Promise<T>,\n    options?: QuizPromiseOptions,\n  ): EnhancedPromise<T> {\n    const defered = Quiz.defer<T>(options)\n\n    task().then(defered.resolve).catch(defered.reject)\n\n    return defered.promise\n  }\n\n  // eslint-disable-next-line @typescript-eslint/promise-function-async\n  static create<T extends unknown>(\n    task: QuizPromiseExecuter<T>,\n    options?: QuizPromiseOptions,\n  ): EnhancedPromise<T> {\n    const defered = Quiz.defer<T>(options)\n\n    task(defered.resolve, defered.reject)\n\n    return defered.promise\n  }\n\n  static promisify =\n    <I extends any[], R>(wrapped: QuizFunctionWithCallback<I, R>) =>\n    async (...args: I): Promise<R> =>\n      new Promise((resolve, reject) => {\n        wrapped(...args, (error: QuizCallbackError, results: R) => {\n          error ? reject(error) : resolve(results)\n        })\n      })\n\n  static deferify =\n    <I extends any[], R, F = any>(wrapped: QuizFunctionWithCallback<I, R>) =>\n    (...args: I): QuizDeferifyPromise<R, F> => {\n      const defer = Quiz.defer<R>()\n\n      // @ts-expect-error\n      defer.forward = wrapped(...args, (error: QuizCallbackError, results: R) =>\n        error ? defer.reject(error) : defer.resolve(results))\n\n      return defer as any\n    }\n}\n\nexport type {\n  EnhancedPromise,\n  QuizCallbackError,\n  QuizDeferifyPromise,\n  QuizDeferPromise,\n  QuizFunctionCallback,\n  QuizFunctionWithCallback,\n  QuizPromiseExecuter,\n  QuizPromiseOptions,\n  QuizQueueItem,\n  QuizThroatOptions,\n}\n\nexport default Quiz\n"],"names":["fastObjectProperties","data","create","Quiz","wrap","run","context","this","Promise","resolve","reject","_arguments","arguments","apply","slice","call","error","e","immediate","task","then","timeout","delay","setTimeout","throat","list","options","Array","isArray","Error","opts","Object","assign","concurrency","defaults","schedule","map","all","from","promises","keys","values","recevied","reduce","acc","item","idx","_Object$assign","concat","defer","cancelable","defered","state","is","finalled","resolved","rejected","promise","cancel","name","timer","flush","clearTimeout","race","_arguments3","promisify","wrapped","_arguments4","results","deferify","forward"],"mappings":"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"}